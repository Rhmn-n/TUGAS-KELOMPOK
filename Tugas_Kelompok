import streamlit as st
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from pulp import LpMaximize, LpProblem, LpVariable

st.set_page_config(page_title="Sistem Pemilihan Model Industri", layout="centered")
st.title("ğŸ­ Sistem Pemilihan Model Matematika Industri")

# Pilihan model
model = st.sidebar.selectbox("Pilih Model Matematis:", (
    "Model Antrian M/M/1",
    "Model EOQ",
    "Optimasi Produksi Beras",
    "Model Transportasi"
))

if model == "Model Antrian M/M/1":
    st.header("â³ Simulasi Antrian - Model M/M/1")
    lambda_val = st.number_input("Rata-rata kedatangan per jam (Î»)", min_value=0.1, value=4.0)
    mu_val = st.number_input("Rata-rata pelayanan per jam (Î¼)", min_value=0.1, value=6.0)

    if lambda_val >= mu_val:
        st.error("âš ï¸ Sistem tidak stabil! Î» harus lebih kecil dari Î¼.")
    else:
        rho = lambda_val / mu_val
        L = lambda_val / (mu_val - lambda_val)
        Lq = (lambda_val**2) / (mu_val * (mu_val - lambda_val))
        W = 1 / (mu_val - lambda_val)
        Wq = lambda_val / (mu_val * (mu_val - lambda_val))

        st.subheader("ğŸ“ˆ Hasil Perhitungan")
        st.write(f"**Utilisasi sistem (Ï):** {rho:.2f}")
        st.write(f"**Rata-rata pelanggan dalam sistem (L):** {L:.2f}")
        st.write(f"**Rata-rata pelanggan dalam antrian (Lq):** {Lq:.2f}")
        st.write(f"**Waktu rata-rata dalam sistem (W):** {W:.2f} jam")
        st.write(f"**Waktu rata-rata menunggu (Wq):** {Wq:.2f} jam")

        st.subheader("ğŸ“Š Grafik: Jumlah Pelanggan vs Tingkat Kedatangan")
        lambdas = np.linspace(0.1, mu_val - 0.01, 100)
        Ls = lambdas / (mu_val - lambdas)
        Lqs = (lambdas**2) / (mu_val * (mu_val - lambdas))

        fig, ax = plt.subplots()
        ax.plot(lambdas, Ls, label='L (dalam sistem)', color='blue')
        ax.plot(lambdas, Lqs, label='Lq (dalam antrian)', color='orange')
        ax.axvline(lambda_val, color='red', linestyle='--', label=f"Î» saat ini = {lambda_val}")
        ax.set_xlabel("Î» (Kedatangan per jam)")
        ax.set_ylabel("Jumlah pelanggan")
        ax.set_title("Simulasi Antrian M/M/1")
        ax.legend()
        ax.grid(True)
        st.pyplot(fig)

elif model == "Model EOQ":
    st.header("ğŸ“¦ Perhitungan EOQ (Economic Order Quantity)")
    D = st.number_input("Permintaan bulanan (kg)", min_value=1, value=10000)
    S = st.number_input("Biaya pemesanan per kali order (Rp)", min_value=1, value=200000)
    H = st.number_input("Biaya simpan per kg per bulan (Rp)", min_value=1, value=100)

    EOQ = (2 * D * S / H) ** 0.5
    st.subheader("ğŸ“Š Hasil Perhitungan EOQ")
    st.write(f"**EOQ Optimal:** {EOQ:.2f} kg per order")

    st.subheader("ğŸ“ˆ Grafik Biaya vs Jumlah Pemesanan")
    Q = np.linspace(100, D * 2, 500)
    biaya_pesan = (D / Q) * S
    biaya_simpan = (Q / 2) * H
    total_biaya = biaya_pesan + biaya_simpan

    fig, ax = plt.subplots()
    ax.plot(Q, biaya_pesan, label='Biaya Pemesanan', linestyle='--')
    ax.plot(Q, biaya_simpan, label='Biaya Penyimpanan', linestyle='--')
    ax.plot(Q, total_biaya, label='Total Biaya', color='black', linewidth=2)
    ax.axvline(EOQ, color='red', linestyle=':', label=f'EOQ â‰ˆ {EOQ:.0f} kg')
    ax.set_xlabel('Jumlah Pemesanan (kg)')
    ax.set_ylabel('Biaya (Rp)')
    ax.set_title('Grafik EOQ: Biaya vs Jumlah Pemesanan')
    ax.legend()
    ax.grid(True)
    st.pyplot(fig)

elif model == "Optimasi Produksi Beras":
    st.header("ğŸ“Š Optimasi Produksi Beras")
    total_gabah = st.number_input("Jumlah Gabah Tersedia (kg)", min_value=0.0, value=10000.0)

    st.subheader("âš™ï¸ Data Beras Premium")
    premium_gabah = st.number_input("Gabah/kg untuk Beras Premium", min_value=0.1, value=1.2)
    premium_harga = st.number_input("Harga Jual/kg Beras Premium (Rp)", value=12000)
    premium_biaya = st.number_input("Biaya Produksi/kg Beras Premium (Rp)", value=6000)

    st.subheader("âš™ï¸ Data Beras Medium")
    medium_gabah = st.number_input("Gabah/kg untuk Beras Medium", min_value=0.1, value=1.0)
    medium_harga = st.number_input("Harga Jual/kg Beras Medium (Rp)", value=9000)
    medium_biaya = st.number_input("Biaya Produksi/kg Beras Medium (Rp)", value=5000)

    if st.button("ğŸš€ Hitung Optimasi"):
        profit_premium = premium_harga - premium_biaya
        profit_medium = medium_harga - medium_biaya
        model_lp = LpProblem("Optimasi_Produksi_Beras", LpMaximize)
        x = LpVariable("Beras_Premium", lowBound=0)
        y = LpVariable("Beras_Medium", lowBound=0)
        model_lp += profit_premium * x + profit_medium * y
        model_lp += premium_gabah * x + medium_gabah * y <= total_gabah
        model_lp.solve()
        x_val = x.varValue
        y_val = y.varValue
        total_profit = profit_premium * x_val + profit_medium * y_val

        st.subheader("ğŸ“ˆ Hasil Optimasi Produksi")
        st.success(f"âœ… Produksi Beras Premium: {x_val:.2f} kg")
        st.success(f"âœ… Produksi Beras Medium: {y_val:.2f} kg")
        st.success(f"ğŸ’° Total Keuntungan Maksimum: Rp {total_profit:,.0f}")

        st.subheader("ğŸ“Š Grafik Produksi")
        fig, ax = plt.subplots()
        ax.bar(["Beras Premium", "Beras Medium"], [x_val, y_val], color=["green", "orange"])
        ax.set_ylabel("Jumlah Produksi (kg)")
        ax.set_title("Perbandingan Produksi Beras")
        st.pyplot(fig)

elif model == "Model Transportasi":
    st.header("ğŸšš Optimasi Model Transportasi (Northwest Corner)")
    m = st.number_input("Jumlah sumber", min_value=1, value=3)
    n = st.number_input("Jumlah tujuan", min_value=1, value=3)

    st.subheader("ğŸ’° Matriks Biaya Pengiriman (Rp)")
    costs = []
    for i in range(m):
        row = st.text_input(f"Biaya dari Sumber {i+1} ke semua tujuan (pisahkan dengan koma)", value="5,8,6")
        costs.append([int(x) for x in row.strip().split(",")])

    supply = st.text_input("ğŸ“¦ Supply dari setiap sumber (pisahkan dengan koma)", value="20,30,25")
    demand = st.text_input("ğŸ Permintaan dari setiap tujuan (pisahkan dengan koma)", value="10,30,35")

    supply = [int(x) for x in supply.strip().split(",")]
    demand = [int(x) for x in demand.strip().split(",")]

    if sum(supply) != sum(demand):
        st.warning("âš ï¸ Supply dan demand tidak seimbang! Silakan sesuaikan dulu.")
    else:
        allocation = np.zeros((m, n), dtype=int)
        i = j = 0
        supply_cp = supply.copy()
        demand_cp = demand.copy()
        while i < m and j < n:
            alloc = min(supply_cp[i], demand_cp[j])
            allocation[i][j] = alloc
            supply_cp[i] -= alloc
            demand_cp[j] -= alloc
            if supply_cp[i] == 0:
                i += 1
            else:
                j += 1

        cost_matrix = np.array(costs)
        total_cost = np.sum(allocation * cost_matrix)

        st.subheader("ğŸ“¦ Matriks Alokasi Barang")
        df_result = pd.DataFrame(allocation, columns=[f"Tujuan {j+1}" for j in range(n)], index=[f"Sumber {i+1}" for i in range(m)])
        st.dataframe(df_result)

        st.subheader("ğŸ’µ Matriks Biaya")
        df_cost = pd.DataFrame(cost_matrix, columns=[f"Tujuan {j+1}" for j in range(n)], index=[f"Sumber {i+1}" for i in range(m)])
        st.dataframe(df_cost)

        st.success(f"âœ… Total Biaya Transportasi Minimum (dengan Northwest Corner): Rp {total_cost:,}")

        fig, ax = plt.subplots()
        ax.set_title("Peta Alokasi Transportasi")
        cax = ax.matshow(allocation, cmap="Blues")
        for (i, j), val in np.ndenumerate(allocation):
            ax.text(j, i, f"{val}", ha='center', va='center')
        ax.set_xticks(np.arange(n))
        ax.set_xticklabels([f"Tujuan {j+1}" for j in range(n)])
        ax.set_yticks(np.arange(m))
        ax.set_yticklabels([f"Sumber {i+1}" for i in range(m)])
        fig.colorbar(cax)
        st.pyplot(fig)
